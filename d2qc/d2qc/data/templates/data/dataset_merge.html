{% extends "base.html" %}
{% block css %}
{% load mathfilters %}
<link rel="stylesheet" type="text/css"
href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v5.3.0/css/ol.css">
<style>
    #plot {
        height: 600px;
        width: 600px;
    }
    .outer {
      display: flex;
    }
    .dataset.data{
        display: flex;
        justify-content: flex-start;
        align-items: flex-start;
    }
    .dataset.data .selected,
    .dataset.data .selected a {
        background-color: black;
        color: white;
        font-weight: bold;
    }
    .dataset.data td {
        vertical-align: top;
    }
    .dataset-top {
        display: flex;
        justify-content: flex-start;
    }
    .head-wrapper {
      order: 2;
      padding: 10px;
    }
    .map-wrapper {
      order: 1;
      padding: 10px;
    }
    .save {
      display: flex;
      flex-direction: column;

    }
    .save>* {
      margin: 0 0 20px;
    }
</style>
<link rel="stylesheet" href="//cdn.jsdelivr.net/chartist.js/latest/chartist.min.css">
{% endblock %}
{% block js %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
{% endblock%}
{% block content %}
<style>
.mergeform {
  display: flex;
  flex-wrap: wrap;
  width: 400px;
  justify-content: center;
}
.mergebutton, .mergeinfo {
  width: 100%
}
.column {
  display: flex;
  width: 80px;
  flex-wrap: wrap;
  justify-content: flex-start;
}
.column h4 {
  width: 100%;
}
.column.params {
  width: auto;
}
.column > * > li{
  display: block;
  height: 25px;
  padding: 0;
  margin: 0;
}
.column input {
  margin: 0;
  padding: 0;
}
.column ul {
  padding: 0 4px;
  margin:0;
  display: block;
  max-width: 100px;
  overflow: hidden;
}
.column fieldset {
  border: none;
}
#id_merge_type {
  max-width: 100%;
  margin: 0 0 10px;
}
</style>
<h3>
  <a href="{% url 'data_set-detail' object.id %}">
    ID: {{ object.id }} - {{ object.expocode }}
  </a>
</h3>
<div class="outer">
  <form class="mergeform" method="post">
    {% csrf_token %}
    <div class="pri column">
      <h4>Primary</h4>
      {{form.primary}}
    </div>
    <div class="sec column">
      <h4>Secondary</h4>
      {{form.secondary}}
    </div>
    <div class="params column">
      <h4>Name</h4>
      <ul>
      {% for data_type in data_types %}
      <li
      {% if parameter.id == data_type.id %}
      class="selected"
      {% endif %}
      title="{{ data_type.original_label }}"
      >
          <a
            href="{% url 'data_set_parameter-detail' object.id data_type.id %}"
          >
            {{ data_type.original_label }}
          </a>
      </li>
      {% endfor %}
      </ul>
    </div>
    <div class="mergeinfo">
      <p></p>
    </div>
    <input class="mergebutton" type="submit"
    value="Plot selected parameters" name="plot_parameters"/>
    <h3>Merging</h3>
    <p>To merge the selected parameters, choose the appropriate action from
      the select box below, and click Save merge parameter. This will create
      a new variable in the database named primary_secondary_#, where
    primary is the name of the primary parameter etc, and # is the merge action.</p>
    {{form.merge_type}}

    <input class="mergebutton" type="submit"
    value="Save merge parameter" name="save_parameters"/>
  </form>
  <div id="plot">
  </div>
  {% if merge_data %}
  <script type="text/javascript">
    var merge_data =   JSON.parse('{{ merge_data | escapejs }}');

    var plot = {
      x: merge_data.diff,
      y: merge_data.depth,
      type: 'scatter',
      mode: 'markers'
    }
    var xmax = Math.max(
      Math.abs(Math.max(...merge_data.diff)),
      Math.abs(Math.max(...merge_data.diff))
    );

    var layout = {
        yaxis: {autorange: 'reversed', rangemode: 'tozero'},
        xaxis: {range: [-1 * (xmax + (xmax/10)), xmax + (xmax/10)]}
    };
    var mergeplot = Plotly.newPlot('plot', [plot], layout);
  </script>
  {% else %}
  <p>Please choose parameters to display plot</p>
  {% endif %}
</div>
{% endblock %}
