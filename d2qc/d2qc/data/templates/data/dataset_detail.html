{% extends "base.html" %}
{% block css %}
{% load mathfilters %}
<link rel="stylesheet" type="text/css"
href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v5.3.0/css/ol.css">
<style>
    #map {
        height: 300px;
        width: 450px;
    }
    .dataset.data{
        display: flex;
        justify-content: flex-start;
        align-items: flex-start;
    }
    .dataset.data .selected,
    .dataset.data .selected a {
        background-color: black;
        color: white;
        font-weight: bold;
    }
    .dataset.data td {
        vertical-align: top;
    }
    .dataset-top {
        display: flex;
        justify-content: flex-start;
    }
    .head-wrapper {
      order: 2;
      padding: 10px;
    }
    .map-wrapper {
      order: 1;
      padding: 10px;
    }
</style>
<link rel="stylesheet" href="//cdn.jsdelivr.net/chartist.js/latest/chartist.min.css">
{% endblock %}
{% block js %}
<script type="text/javascript"
src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v5.3.0/build/ol.js">
</script>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
{% endblock%}
{% block content %}
    <div>
        <div class="dataset-top">
            <div class="head-wrapper">
                <h3>
                    ID: {{ object.id }} - {{ object.expocode }}
                </h3>
                {% if object.is_reference %}
                <h4>
                    This data set is a reference data set
                </h4>
                {% endif %}
                <aside>
                    <div class="query_setup">
                        <h4>Current setup</h4>
                        <dl>
                            <dt>Query radius (km)</dt>
                            <dd>{{ user.profile.crossover_radius |div:1000 }}</dd>
                            <dt>Minimum depth</dt>
                            <dd>{{ user.profile.min_depth }}</dd>
                        </dl>
                    </div>
                </aside>
            </div>
            <div class="map-wrapper">
                <h4>
                    {% if parameter %}
                    Stations with {{ parameter.original_label }} sampling
                    {% else %}
                    All stations
                    {% endif %}
                </h4>
                <div id="map">
                </div>
                <a href="{% url 'data_set-detail' object.id %}">
                        [Show all stations]
                </a>
            </div>
        </div>

        <div class="dataset data">
            <dl>
                <dt>ID</dt>
                <dd>{{ object.id }}</dd>
                <dt>Expocode</dt>
                <dd>{{ object.expocode }}</dd>
                <dt>Parent file</dt>
                <dd>{{ object.data_file.name }}</dd>
                <dt>Variables in this data set
                </dt>
                <dd>
                    <table border="1" cellpadding="10" cellspacing="0">
                        <thead>
                            <tr>
                                <th>Variable name</th>
                                <th>Crossover data sets
                                {% if parameter.original_label %}
                                : {{ parameter.original_label }}
                                {% endif %}
                                </th>
                                <th>
                                    Profiles
                                </th>
                                <th>
                                    Statistics
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>
                                    <table border="0" cellpadding="5">
                                        <tbody>
                                            {% for data_type in data_types %}
                                            <tr
                                            {% if parameter.id == data_type.id %}
                                            class="selected"
                                            {% endif %}
                                            >
                                                <td>
                                                    <a
                                                        href="{% url 'data_set_parameter-detail' object.id data_type.id %}"
                                                    >
                                                        {{ data_type.original_label }}
                                                    </a>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </td>
                                <td>
                                    {% if crossover_datasets %}
                                    <table border="0" cellpadding="5">
                                        <tbody>
                                            {% for data_set in crossover_datasets %}
                                            <tr
                                            {% if crossover_data_set_id == data_set.0 %}
                                            class="selected"
                                            {% endif %}
                                            >
                                                <td>
                                                    <a href="{% url 'data_set_crossover' object.id parameter.id data_set.0 %}">
                                                        {{data_set.1}}, {{data_set.2}} stations
                                                    </a>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                    {% endif%}
                                </td>
                                <td>
                                    <div id="profiles"
                                        style="width: 500px; height: 600px">
                                    </div>
                                </td>
                                <td>
                                    <div id="stats"
                                        style="width: 300px; height: 600px">
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </dd>
                <dd>
                  <div class="summary-wrapper">
                    {% if summary_stats %}
                    <div id="summary-stats"
                        style="width: 100%; height: 600px">
                    </div>
                    {% elif parameter %}
                    <img src="https://i.gifer.com/8vEg.gif" width="100" />
                    <p>Calculating summary statistics</p>
                    {% endif %}
                  </div>
                </dd>
            </dl>
        </div>
        <script type="text/javascript">

            var raster = new ol.layer.Tile({
                source: new ol.source.OSM()
            });
            var stations = '{{ station_positions }}';
            var crossovers = '{{ crossover_positions }}';
            var stations_polygon = '{{ stations_polygon }}'
            var features = []
            red = new ol.style.Style({
                image: new ol.style.Circle({
                    fill: new ol.style.Fill({
                        color: [255,0,0,.4]
                    }),
                    radius: 3,
                })
            });
            blue = new ol.style.Style({
                image: new ol.style.Circle({
                    fill: new ol.style.Fill({
                        color: [0,0,255,1]
                    }),
                    radius: 3,
                })
            });
            blue_line = new ol.style.Style({
              stroke: new ol.style.Stroke({
                color: [0,0,255,1],
              })
            });


            var format = new ol.format.WKT();

            var feature = format.readFeature(stations, {
                dataProjection: 'EPSG:4326',
                featureProjection: 'EPSG:3857'
            });
            feature.setStyle(blue)
            // Add stations from data set as first layer
            features.push(feature)

            var cross_feature = null
            if (crossovers && crossovers != 'None') {
                cross_feature = format.readFeature(crossovers, {
                    dataProjection: 'EPSG:4326',
                    featureProjection: 'EPSG:3857'
                });
                cross_feature.setStyle(red);
                features.push(cross_feature)
            }
            var buffer_feature = null
            if (stations_polygon && stations_polygon != 'None')
              buffer_feature = format.readFeature(stations_polygon, {
                dataProjection: 'EPSG:4326',
                featureProjection: 'EPSG:3857'
              });
              buffer_feature.setStyle(blue_line);
              features.push(buffer_feature)

            var source = new ol.source.Vector({
                features: features
            })
            var vector = new ol.layer.Vector({
                source: source
            });

            var map = new ol.Map({
                layers: [raster, vector],
                target: 'map',
            });
            map.getView().fit(source.getExtent(), map.getSize())
            map.getView().setZoom(map.getView().getZoom() - 1)

            // Profiles:
            var data = []
            var profiles = JSON.parse('{{ dataset_profiles | escapejs }}');
            var interp_profiles = JSON.parse('{{ dataset_interp_profiles | escapejs }}');

            // Reference dataset
            var profiles_ref = JSON.parse('{{ dataset_ref_profiles | escapejs }}');
            var interp_profiles_ref = JSON.parse('{{ dataset_ref_interp_profiles | escapejs }}');

            // Stats
            var stats = JSON.parse('{{ dataset_stats | escapejs }}');

            var current_dataset = 0;
            var data_set_id = parseInt('{{ object.id }}')
            var blue = 'rgb(75,75,255)'
            var bluetransp = 'rgba(75,75,255, .1)'
            var red = 'rgb(255,75,75)'


            for (var i=0; i<interp_profiles.length; i++) {
                var showlegend = false
                if (i == 0) {
                    showlegend = true
                }
                profile = createProfile(
                    interp_profiles[i],
                    blue,
                    showlegend,
                    true
                )
                if(profile) {
                    data.push(profile)
                }
            }

            // Min and max values for the plotting parameter
            var param_max = Number.MIN_VALUE
            var param_min = Number.MAX_VALUE

            for (var i=0; i<profiles.length; i++) {
                profile = createProfile(profiles[i], blue, false, false)
                if(profile) {
                    data.push(profile)
                    param_max = Math.max(param_max, ...profiles[i].param.data)
                    param_min = Math.min(param_min, ...profiles[i].param.data)
                }
            }
            for (var i=0; i<profiles_ref.length; i++) {
                profile = createProfile(profiles_ref[i], red, false, false)
                if(profile) {
                    data.push(profile)
                    param_max = Math.max(param_max, ...profiles_ref[i].param.data)
                    param_min = Math.min(param_min, ...profiles_ref[i].param.data)
                }
            }
            for (var i=0; i<interp_profiles_ref.length; i++) {
                var showlegend = false
                if (i == 0) {
                    showlegend = true
                }
                profile = createProfile(interp_profiles_ref[i], red, showlegend, true)
                if(profile) {
                    data.push(profile)
                }
            }

            // Check stats are not empty
            if (stats.hasOwnProperty('y')) {
                // Indicate where statistics are valid
                min_stat = Math.min(...stats.y)
                max_stat = Math.max(...stats.y)
                diff_stat = max_stat-min_stat
                diff_param = param_max - param_min
                var stats_limits = {
                    x: [
                        param_min,
                        param_max,
                        param_max,
                        param_max + diff_param / 14,
                    ],
                    y: [
                        min_stat,
                        min_stat,
                        min_stat - diff_stat / 5,
                        min_stat + diff_stat / 2,
                    ],
                    mode: 'lines',
                    type: 'scatter',
                    line: {
                      color: bluetransp,
                    },
                    marker: {
                      color: bluetransp,
                    },
                    showlegend: false
                }
                stats_fill = JSON.parse(JSON.stringify(stats_limits))
                stats_fill.y = [
                    max_stat,
                    max_stat,
                    max_stat + diff_stat / 5,
                    max_stat - diff_stat / 2,
                ]
                stats_fill.fill = 'tonexty'
                stats_fill.fillcolor = bluetransp
                stats_fill.showlegend = true
                stats_fill.name = 'Matching crossover area'

                // Add these to the beginning of the data array
                data.unshift(stats_fill)
                data.unshift(stats_limits)
            }

            var layout = {
                yaxis: {autorange: 'reversed',title: {text:'Sigma 4'}},
                xaxis: {title: {text:profiles[0].parameter}},
                margin: {l: 60, r:0},
                legend: {orientation: 'h'},
                hovermode: 'y'
            };
            Plotly.newPlot('profiles', data, layout);
            /* create a profile for the profile plot */
            function createProfile(p, color, showlegend, line) {
                if (!('param' in p)) {
                    return []
                }

                var profile = {
                    x: Object.values(p.param.data),
                    y: Object.values(p.sigma4.data),
                    mode: 'markers',
                    showlegend: showlegend,
                    name: '',
                    marker: {
                      color: color,
                      size: 3,
                    },
                }
                if (line) {
                  profile.mode = 'lines'
                  profile.line = {
                    color: color,
                    width: 1,
                  }
                  profile.hoverinfo = 'skip'
                }
                if (showlegend) {
                    profile.name = p.expocode
                }
                return profile
            }

            if (stats.hasOwnProperty('y')) {
                // Plot stats
                var data = []
                var mean = {
                  x: stats.mean,
                  y: stats.y,
                  mode: 'markers',
                  type: 'scatter',
                  marker: {
                    color: blue
                  },
                  name: 'Mean'
                };

                var stdev_plus = {
                  x: stats.mean.map(function (v, i) {return stats.stdev[i] == null ? null : v + stats.stdev[i]}),
                  y: stats.y,
                  mode: 'lines',
                  type: 'scatter',
                  line: {
                    color: blue
                  },
                  name: '&#177;  St. dev'
                };
                var stdev_min = {
                  x: stats.mean.map(function (v, i) {return stats.stdev[i] == null ? null : v - stats.stdev[i]}),
                  y: stats.y,
                  mode: 'lines',
                  type: 'scatter',
                  line: {
                    color: blue
                  },
                  showlegend: false,
                  name: '&#177;  St. dev'
                };
                var w_mean = {
                  x: [stats.w_mean, stats.w_mean],
                  y: [Math.min(...stats.y), Math.max(...stats.y)],
                  mode: 'lines',
                  type: 'scatter',
                  line: {
                    color: red
                  },
                  name: 'Weighted mean'
                };
                var w_std_plus = {
                  x: [stats.w_mean + stats.w_stdev, stats.w_mean + stats.w_stdev],
                  y: [Math.min(...stats.y), Math.max(...stats.y)],
                  mode: 'lines',
                  type: 'scatter',
                  line: {
                    color: red,
                    dash: 'dot'
                  },
                  name: 'Weighted st. dev'
                };
                var w_std_min = {
                  x: [stats.w_mean - stats.w_stdev, stats.w_mean - stats.w_stdev],
                  y: [Math.min(...stats.y), Math.max(...stats.y)],
                  mode: 'lines',
                  type: 'scatter',
                  line: {
                    color: red,
                    dash: 'dot'
                  },
                  name: 'Weighted st. dev',
                  showlegend: false
                };


                var data = [
                    mean,
                    stdev_plus,
                    stdev_min,
                    w_mean,
                    w_std_plus,
                    w_std_min
                ];
                var layout = {
                    yaxis: {autorange: 'reversed',title: {text:'Sigma 4'}},
                    margin: {l: 60, r:0},
                    legend: {orientation: 'h'},
                    hovermode: 'y'
                };

                Plotly.newPlot('stats', data, layout);
            }
            {% if summary_stats %}
            var summary_stats = JSON.parse('{{ summary_stats | escapejs }}');
            w_mean = {
              x: summary_stats.date,
              y: summary_stats.w_mean,
              text: summary_stats.expocode,
              textposition: 'top',
              error_y: {
                type: 'data',
                array: summary_stats.w_stdev,
                visible: true
              },
              mode: 'markers+text',
              type: 'scatter',
              line: {
                color: 'black'
              },
              hoverinfo: 'text',
              textposition: 'top right',
              name: 'Weighted mean &plusmn; st. dev'
            };
            mean = {
              x: summary_stats.date,
              y: summary_stats.mean,
              mode: 'lines',
              type: 'scatter',
              line: {
                color: red
              },
              name: 'Weighted mean',
              hoverinfo: 'text',
              hovertext:
                'Mean ' + summary_stats.mean[0].toFixed(4) + '<br>'
                  + 'Stdev &plusmn;' + summary_stats.stdev[0].toFixed(4)
            };
            stdev = {
              x: summary_stats.date,
              y: summary_stats.mean.map(function(x, i){return x + summary_stats.stdev[i];}),
              mode: 'lines',
              type: 'scatter',
              line: {
                color: red,
                dash: 'dot'
              },
              name: 'Stdev',
              hoverinfo: 'skip'
            };
            stdev2 = {
              x: summary_stats.date,
              y: summary_stats.mean.map(function(x, i){return x - summary_stats.stdev[i];}),
              mode: 'lines',
              type: 'scatter',
              line: {
                color: red,
                dash: 'dot'
              },
              showlegend: false,
              hoverinfo: 'skip'
            };

            data = [
              w_mean,
              mean,
              stdev,
              stdev2
            ]
            layout = {
                yaxis: {title: {text:'Offset'}},
                margin: {l: 60, r:0},
                legend: {orientation: 'h'},
                hovermode: 'x'
            };

            Plotly.newPlot('summary-stats', data, layout);


            {% endif %}

          </script>

        <a href="{% url 'data_set-delete' object.id %}">[Delete dataset]</a>
    </div>
{% endblock %}
